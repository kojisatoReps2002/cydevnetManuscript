【アプリの親子関係について - その2】(2016/09/06)

前回の記事(リンク)では、kintone における親子関係について、アプリストアの「商品見積書パック」を例に、便宜的な呼び方としての「同居親子関係」「独立親子関係」それぞれ実際のデータを見ながら、どのような振る舞いとなるかの考察と確認を行って参りました。

今回も引き続き、同アプリパックを例に「独立親子関係」の表現を補完する働きを持つ「関連レコード一覧」の作用について確認を行い、その後見積明細情報について「同居親子関係」を解消し、独立した時の振る舞いと、そこで有効になるスクリプトの例について説明をさせていただきたいと思います。

まずは、リマインドになるかとは思いますが「関連レコード一覧」とは「自アプリを含むアプリとアプリの間において、設定した二つの項目が持つ、値の一致性を利用して、kintone 内にある情報を一覧して表示する機能」となります。

文章にすると、なんだかわかりにくいですが「商品見積書パック」の場合、例えば商品リストアプリ上に「見積商品一覧」を作成する、つまりその商品がどの見積で参照されているかを表示する、ということになるかと思います。

しかしながら「関連レコード一覧」では、設定できる項目及び項目間に対して、いつくかの制約条件があり、この場合、見積もり明細が「テーブルフィールド」として実装されているため、そこに定義が含まれている「型番」項目については指定をすることができません。

※関連レコードとして定義できるフィールド間の条件
https://help.cybozu.com/ja/k/user/display_relatedrecords.html

繰り返しになりますが「同居親子関係」として「テーブルフィールド」に設定された項目は、一覧(ビュー)上への表示だったり、分類や集計として指定したりする事が可能な点については前回の記事(リンク)でも記載しましたが、上記リンク先の表にある通り「関連レコード」の対象にはなりません。

また、「同居親子関係」の「子」については、上記「関連レコード一覧」の項目として指定できないこと以外に、標準の機能では、csvインポートの対象とはならないこと(出力は可能)も注意が必要です。もちろん、カスタマイズによって対応することは可能ですので、その場合は、以下の記事が参考になるかと思います。

[テーブルデータをCSVでインポートしてみよう!]
https://cybozudev.zendesk.com/hc/ja/articles/204972070
[テーブルデータをCSVでアップデートしてみよう!]
https://cybozudev.zendesk.com/hc/ja/articles/208399613

さて、実際の kintone の利用局面では、上記のような制約、特に「テーブルフィールド」に対して、標準機能ではファイルi/oの実現が出来ない点は導入の障壁になる事が多く、上記リンク情報等を活用したカスタマイズの開発が検討されるところではありますが、もう一つの考え方として「同居親子関係」の「子」である「見積明細」を「独立親子関係」として独立させてしまうという方法があります。

[fig 1. (dn1608explanatory.pptx slide 3)]

具体的には見積明細というアプリを新規に作成し、項目として見積書アプリの「テーブルフィールド」にあった項目を全て定義し、そこに見積書アプリの「見積番号」を参照する「ルックアップフィールド」を追加します。

また、見積などの明細行が必要とするキー情報として「明細番号」も追加し、さらに見積明細アプリで分析として使用する事が想定される項目を、見積書アプリからコピーすると便利な任意の項目についても追加します。見積書アプリの場合は、一般的には「宛名」や「見積日」などが候補となるでしょう。

[fig2. (dn16090601.png)]

商品リストアプリを参照する「ルックアップフィールド」及び取得する項目は、特に変更なく元々の定義通りに設定します。このようにすれば、標準機能で「見積明細」に対するcsvファイルによるインポートが標準機能で実現可能となります。集計やグラフなどの分析機能も、適切に「親」情報を取得するように設定すれば「同居親子関係」同様に実現できます。

見積明細アプリができましたら、見積書アプリでは「テーブルフィールド」にある明細の情報は削除し、代わりに「関連レコード一覧」にて表示するレコードの条件を[見積書].[見積番号]=[見積明細].[見積番号]とし「見積書」アプリ上に表示したい「見積明細」アプリの項目を定義します。

[fig3. (dn16090602.png)]

以上の設定によって、めでたく「見積書」と「見積明細」はこれまでの「同居親子関係」から、それぞれ独立したアプリとなり「見積番号」をキーに「独立親子関係」を築くことになりました。ひとつのアプリになることにより、 kintone の提供する集計、グラフ、履歴管理、コミュニケーション機能がそれぞれに提供されるのも、一つのポジティブなモチベーションになるかと思います。

ところで、この見積明細アプリの小計金額ですが、見積書アプリの「関連レコード」として表示されているものは「テーブルフィールド」のように、計算項目として指定することが出来ないため、合計金額を見積書アプリに表示させるためには、jsカスタマイズのコードが必要となります。

以前の記事(リンク:https://cybozudev.zendesk.com/hc/ja/articles/203030394))でも取り上げさせて頂きましたが、その時には単に計算結果を表示するだけでしたので一覧への表示やグラフの集計項目として指定することはできませんでした。

そこで、今回は独立記念として(!)見積書アプリに項目として「お見積金額」を追加し、関連レコードの小計金額を合計した更新結果を反映するようにしたいと思います。

[fig4. (dn16090603.png)]



























